name: AEGIS CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # Build & Test
  # ═══════════════════════════════════════════════════════════════════════════
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust Nightly
      uses: dtolnay/rust-toolchain@nightly
      with:
        components: rust-src, llvm-tools-preview
    
    - name: Cache Cargo
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build (Host Target)
      run: cargo build --lib --target x86_64-unknown-linux-gnu
    
    - name: Run Tests
      run: cargo test --lib --target x86_64-unknown-linux-gnu
    
    - name: Check Formatting
      run: cargo fmt -- --check
    
    - name: Clippy
      run: cargo clippy --lib --target x86_64-unknown-linux-gnu -- -D warnings

  # ═══════════════════════════════════════════════════════════════════════════
  # Docker Build
  # ═══════════════════════════════════════════════════════════════════════════
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: aegis:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Test Docker REPL
      run: |
        docker run --rm aegis:test --help
        docker run --rm aegis:test version

  # ═══════════════════════════════════════════════════════════════════════════
  # AEGIS Script Validation
  # ═══════════════════════════════════════════════════════════════════════════
  validate-scripts:
    name: Validate .aegis Scripts
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Lint AEGIS Scripts
      run: |
        echo "Validating .aegis example scripts..."
        for file in examples/*.aegis; do
          echo "Checking: $file"
          # Validate syntax (basic check)
          grep -E "^(manifold|block|regress|render|//)" "$file" > /dev/null || \
            (echo "Invalid syntax in $file" && exit 1)
        done
        echo "All scripts valid!"

  # ═══════════════════════════════════════════════════════════════════════════
  # Documentation
  # ═══════════════════════════════════════════════════════════════════════════
  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust Nightly
      uses: dtolnay/rust-toolchain@nightly
    
    - name: Generate Docs
      run: cargo doc --no-deps --lib
    
    - name: Upload Docs Artifact
      uses: actions/upload-artifact@v3
      with:
        name: documentation
        path: target/doc

  # ═══════════════════════════════════════════════════════════════════════════
  # Release (on tag)
  # ═══════════════════════════════════════════════════════════════════════════
  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build, docker]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
